name: ChatOps Migration Deployment

on:
  issue_comment:
    types: [created]

env:
  BYTEBASE_URL: http://13.232.242.131:8080
  BYTEBASE_SERVICE_ACCOUNT: api-sample@service.bytebase.com
  BYTEBASE_SERVICE_ACCOUNT_SECRET: ${{ secrets.BYTEBASE_SERVICE_ACCOUNT_SECRET }}
  BYTEBASE_PROJECT: "projects/new-project"
  FILE_PATTERN: "migrations-semver/*.sql"

jobs:
  parse-command:
    if: github.event.issue.pull_request && startsWith(github.event.comment.body, '/migrate')
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.parse.outputs.environment }}
      valid-command: ${{ steps.parse.outputs.valid-command }}
      stage: ${{ steps.parse.outputs.stage }}
      targets: ${{ steps.parse.outputs.targets }}
    steps:
      - name: Write command config
        run: |
          cat <<EOF > ${{ runner.temp }}/bytebase-action-config.yaml
          test:
            stage: environments/test
            targets:
              - instances/neo-mr/databases/RecruitCRM_Test
          EOF
      - name: Parse migrate command
        id: parse
        run: |
          COMMENT="${{ github.event.comment.body }}"
          echo "Comment: $COMMENT"
          
          CONFIG_FILE="${{ runner.temp }}/bytebase-action-config.yaml"
          
          VALID_ENVS=$(yq eval 'keys | join(", ")' "$CONFIG_FILE")
          echo "valid-envs=$VALID_ENVS" >> $GITHUB_OUTPUT

          if [[ $COMMENT =~ ^/migrate[[:space:]]+([a-zA-Z]+) ]]; then
            ENVIRONMENT="${BASH_REMATCH[1]}"
            echo "Parsed environment: $ENVIRONMENT"
            
            if yq eval "has(\"$ENVIRONMENT\")" "$CONFIG_FILE" | grep -q true; then
              echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
              echo "valid-command=true" >> $GITHUB_OUTPUT
              
              STAGE=$(yq eval ".$ENVIRONMENT.stage" "$CONFIG_FILE")
              TARGETS=$(yq eval ".$ENVIRONMENT.targets | join(\",\")" "$CONFIG_FILE")
              
              echo "stage=$STAGE" >> $GITHUB_OUTPUT
              echo "targets=$TARGETS" >> $GITHUB_OUTPUT
            else
              echo "valid-command=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "valid-command=false" >> $GITHUB_OUTPUT
          fi

      - name: Add reaction to comment
        if: steps.parse.outputs.valid-command == 'true'
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ github.event.comment.id }}
          reactions: rocket

      - name: Comment on invalid command
        if: steps.parse.outputs.valid-command == 'false'
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            Invalid migrate command. 
            **Usage:** `/migrate <environment>`  
            **Valid environments:** `${{ steps.parse.outputs.valid-envs }}`
          reactions: confused

  deploy:
    needs: parse-command
    if: needs.parse-command.outputs.valid-command == 'true'
    runs-on: ubuntu-latest
    environment: ${{ needs.parse-command.outputs.environment }}
    container:
      image: bytebase/bytebase-action:latest
    steps:
      - name: Checkout PR merge commit
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.issue.number }}/merge

      - name: Create rollout plan
        id: create-rollout
        env:
          BYTEBASE_TARGETS: ${{ needs.parse-command.outputs.targets }}
          BYTEBASE_OUTPUT: ${{ runner.temp }}/bytebase-metadata.json
        run: |
          bytebase-action rollout \
            --url=${{ env.BYTEBASE_URL }} \
            --project=${{ env.BYTEBASE_PROJECT }} \
            --file-pattern=${{ env.FILE_PATTERN }} \
            --targets=${{ env.BYTEBASE_TARGETS }} \
            --output=${{ env.BYTEBASE_OUTPUT }}

          PLAN=$(jq -r .plan ${{ runner.temp }}/bytebase-metadata.json)
          echo "plan=$PLAN" >> $GITHUB_OUTPUT

      - name: Execute rollout
        env:
          BYTEBASE_TARGET_STAGE: ${{ needs.parse-command.outputs.stage }}
        run: |
          bytebase-action rollout \
            --url=${{ env.BYTEBASE_URL }} \
            --project=${{ env.BYTEBASE_PROJECT }} \
            --target-stage=${{ env.BYTEBASE_TARGET_STAGE }} \
            --plan=${{ steps.create-rollout.outputs.plan }}

      - name: Comment deployment success
        if: success()
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            Migration deployment to `${{ needs.parse-command.outputs.environment }}` completed successfully.

      - name: Comment deployment failure
        if: failure()
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            Migration deployment to `${{ needs.parse-command.outputs.environment }}` failed. Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}).
